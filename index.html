<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Scanner - SharePoint Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px 20px;
        }
        
        .scanner-container {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            height: 300px;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            background: #000;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .scanner-placeholder {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 16px;
            position: relative;
            z-index: 2;
        }
        
        .scanner-active {
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #3b82f6;
            border-radius: 16px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 4;
        }
        
        .scanner-overlay.active {
            opacity: 1;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        .scanner-overlay::before,
        .scanner-overlay::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #3b82f6;
        }
        
        .scanner-overlay::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
        }
        
        .scanner-overlay::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
        }
        
        .btn {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 16px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-green {
            background: linear-gradient(45deg, #10b981, #059669);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-green:hover {
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-purple {
            background: linear-gradient(45deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .btn-purple:hover {
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }
        
        .btn-red {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .btn-red:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            font-family: inherit;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .comment-input {
            min-height: 80px;
            resize: vertical;
        }
        
        .scanned-list {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            min-height: 120px;
        }
        
        .scanned-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .scanned-item:last-child {
            margin-bottom: 0;
        }
        
        .item-part {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .item-desc {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .item-comment {
            color: #3b82f6;
            font-size: 12px;
            font-style: italic;
        }
        
        .item-time {
            color: #9ca3af;
            font-size: 11px;
            margin-top: 4px;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .settings-btn:hover {
            background: white;
            transform: scale(1.05);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            color: #1e293b;
            margin-bottom: 16px;
            font-size: 24px;
            text-align: center;
        }
        
        .modal p {
            color: #64748b;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-buttons .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .modal-buttons .btn-primary:hover {
            background: #2563eb;
        }
        
        .modal-buttons .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .modal-buttons .btn-secondary:hover {
            background: #d1d5db;
        }
        
        .results-modal {
            max-width: 600px;
        }
        
        .results-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .stat-badge {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            min-width: 80px;
        }
        
        .stat-badge.added {
            background: #d1fae5;
            color: #065f46;
        }
        
        .stat-badge.ordered {
            background: #fed7aa;
            color: #9a3412;
        }
        
        .stat-badge.received {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .stat-badge.not-ordered {
            background: #fed7aa;
            color: #9a3412;
        }
        
        .stat-count {
            font-size: 24px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            margin-top: 4px;
        }
        
        .results-table {
            margin-top: 20px;
        }
        
        .result-row {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #e2e8f0;
        }
        
        .result-row.added {
            border-left-color: #10b981;
        }
        
        .result-row.ordered {
            border-left-color: #f59e0b;
        }
        
        .result-row.received {
            border-left-color: #3b82f6;
        }
        
        .result-row.not-ordered {
            border-left-color: #f59e0b;
        }
        
        .result-icon {
            font-size: 20px;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }
        
        .result-info {
            flex: 1;
        }
        
        .result-part {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .result-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }
        
        .result-status.added {
            background: #d1fae5;
            color: #065f46;
        }
        
        .result-status.ordered {
            background: #fed7aa;
            color: #9a3412;
        }
        
        .result-status.received {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .result-status.not-ordered {
            background: #fed7aa;
            color: #9a3412;
        }
        
        .result-po {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: #64748b;
        }
        
        .hidden {
            display: none !important;
        }
        
        .camera-info {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 14px;
            color: #475569;
            text-align: center;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            body {
                padding: 0;
            }
            
            .modal {
                margin: 10px;
                padding: 20px;
            }
            
            .settings-btn {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .stats-row {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .stat-badge {
                flex: 1;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- Settings Button -->
    <button class="settings-btn" onclick="showSettingsModal()" title="Settings">⚙️</button>
    
    <!-- SharePoint URL Modal -->
    <div id="urlModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <h2>🔗 SharePoint Configuration</h2>
            <p>Enter your Power Automate HTTP trigger URL to send scanned items to SharePoint.</p>
            <input type="text" id="modalUrlInput" class="modal-input" placeholder="https://prod-xx.westus.logic.azure.com/workflows/..." autocapitalization="none" spellcheck="false">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 16px; text-align: center;">
                🔒 URL stored securely in your browser only
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveUrlFromModal()">Save URL</button>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal-overlay" style="display: none;">
        <div class="modal results-modal">
            <div class="results-header">
                <h2>📊 Processing Results</h2>
                <p id="resultsSubtitle">Items processed successfully</p>
                
                <div class="stats-row" id="statsRow">
                    <!-- Stats will be populated here -->
                </div>
            </div>
            
            <div class="results-table" id="resultsTable">
                <!-- Results will be populated here -->
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button type="button" class="btn-primary" onclick="closeResultsModal()" style="padding: 12px 32px;">Done</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>📱 QR Scanner</h1>
            <p>Scan QR codes and sync to SharePoint</p>
        </div>
        
        <div class="content">
            <div class="scanner-container">
                <video id="video" autoplay playsinline muted webkit-playsinline></video>
                <div class="scanner-placeholder" id="placeholder">
                    <div style="font-size: 48px; margin-bottom: 16px;">📷</div>
                    <div>Click "Start Scan" to begin scanning</div>
                </div>
                <div class="scanner-active" id="scannerActive">
                    <div style="font-size: 48px; margin-bottom: 16px;">📱</div>
                    <div>Camera Active - Point at QR Code</div>
                    <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Scanner working in background</div>
                </div>
                <div class="scanner-overlay" id="overlay"></div>
            </div>
            
            <div class="camera-info" id="cameraInfo" style="display: none;">
                Camera is active but video preview may not show on iOS Safari. Scanner is still working!
            </div>
            
            <!-- Start Scan Button -->
            <button class="btn" id="startBtn" onclick="startCamera()">Start Scan</button>
            <button class="btn btn-red hidden" id="stopBtn" onclick="stopCamera()">Stop Scan</button>
            
            <!-- Part Number Input -->
            <input type="text" id="partNumberInput" class="input-field" placeholder="Part Number" autocapitalization="none">
            
            <!-- Comments Input -->
            <textarea id="commentInput" class="input-field comment-input" placeholder="Comments"></textarea>
            
            <!-- Add to List Button -->
            <button class="btn btn-green" id="addBtn" onclick="addItemToList()" disabled>Add to List</button>
            
            <!-- Send to SharePoint Button -->
            <button class="btn btn-purple hidden" id="sendBtn" onclick="sendToSharePoint()">
                Send to SharePoint (0 items)
            </button>
            
            <!-- Status Messages -->
            <div id="status"></div>
            
            <!-- Scanned Items List -->
            <div class="scanned-list" id="scannedList">
                <div style="text-align: center; color: #64748b; font-style: italic;">
                    No items added yet
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script>
        // QR Scanner fallback check
        if (typeof QrScanner === 'undefined') {
            console.error('QR Scanner library failed to load');
            // Try alternative CDN
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js';
            script.onload = function() {
                console.log('QR Scanner loaded from fallback CDN');
            };
            script.onerror = function() {
                console.error('Both CDNs failed to load QR Scanner');
                alert('Camera scanning not available. You can still enter part numbers manually.');
            };
            document.head.appendChild(script);
        }
    <script>
        let qrScanner;
        let scannedItems = [];
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        let sharePointURL = '';
        
        // URL Storage functions
        function loadSavedURL() {
            try {
                sharePointURL = localStorage.getItem('qr_scanner_sharepoint_url') || '';
                return sharePointURL;
            } catch (error) {
                console.error('Could not load saved URL:', error);
                return '';
            }
        }
        
        function saveURL(url) {
            try {
                localStorage.setItem('qr_scanner_sharepoint_url', url);
                sharePointURL = url;
                showStatus('URL saved securely in browser', 'success');
                return true;
            } catch (error) {
                console.error('Could not save URL:', error);
                showStatus('Could not save URL', 'error');
                return false;
            }
        }
        
        function clearSavedURL() {
            try {
                localStorage.removeItem('qr_scanner_sharepoint_url');
                sharePointURL = '';
                showStatus('Saved URL cleared', 'info');
            } catch (error) {
                console.error('Could not clear URL:', error);
            }
        }
        
        function checkURLConfiguration() {
            if (!sharePointURL) {
                showURLModal();
                return false;
            }
            return true;
        }
        
        function showURLModal() {
            const modal = document.getElementById('urlModal');
            const input = document.getElementById('modalUrlInput');
            input.value = sharePointURL;
            modal.style.display = 'flex';
            setTimeout(() => input.focus(), 100);
        }
        
        function showSettingsModal() {
            showURLModal();
        }
        
        function closeModal() {
            document.getElementById('urlModal').style.display = 'none';
        }
        
        function saveUrlFromModal() {
            const input = document.getElementById('modalUrlInput');
            const url = input.value.trim();
            
            if (!url) {
                showStatus('Please enter a valid URL', 'error');
                return;
            }
            
            if (!url.startsWith('https://')) {
                showStatus('URL must start with https://', 'error');
                return;
            }
            
            if (saveURL(url)) {
                closeModal();
            }
        }
        
        function updateUI() {
            const listContainer = document.getElementById('scannedList');
            const sendBtn = document.getElementById('sendBtn');
            const addBtn = document.getElementById('addBtn');
            const partNumberInput = document.getElementById('partNumberInput');
            
            // Update Add to List button
            const partNumber = partNumberInput.value.trim();
            addBtn.disabled = !partNumber;
            
            // Update items list
            if (scannedItems.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: #64748b; font-style: italic;">No items added yet</div>';
                sendBtn.classList.add('hidden');
            } else {
                listContainer.innerHTML = scannedItems.map(item => `
                    <div class="scanned-item">
                        <div class="item-part">${item.partNumber}</div>
                        <div class="item-desc">${item.description}</div>
                        ${item.comments ? `<div class="item-comment">💬 ${item.comments}</div>` : ''}
                        <div class="item-time">${new Date(item.timestamp).toLocaleTimeString()}</div>
                    </div>
                `).join('');
                
                sendBtn.classList.remove('hidden');
                sendBtn.textContent = `Send to SharePoint (${scannedItems.length} items)`;
            }
        }
        
        function parseQRCode(data) {
            try {
                if (data.includes('|')) {
                    const [partNumber, description] = data.split('|');
                    return { partNumber: partNumber.trim(), description: description.trim() };
                } else if (data.startsWith('{')) {
                    const parsed = JSON.parse(data);
                    return { partNumber: parsed.partNumber || 'Unknown', description: parsed.description || 'No description' };
                } else {
                    return { partNumber: data, description: 'Scanned QR Code' };
                }
            } catch (error) {
                return { partNumber: data, description: 'Scanned QR Code' };
            }
        }
        
        function handleNewScan(qrData) {
            document.getElementById('partNumberInput').value = qrData;
            stopCamera();
            showStatus('Part number scanned', 'success');
            updateUI();
        }
        
        function addItemToList() {
            const partNumberInput = document.getElementById('partNumberInput');
            const commentInput = document.getElementById('commentInput');
            
            const partNumber = partNumberInput.value.trim();
            const comments = commentInput.value.trim();
            
            if (!partNumber) {
                showStatus('Please enter or scan a part number', 'error');
                return;
            }
            
            const parsed = parseQRCode(partNumber);
            const newItem = {
                ...parsed,
                comments: comments,
                timestamp: new Date().toISOString()
            };
            
            // Check for duplicates
            const isDuplicate = scannedItems.some(item => 
                item.partNumber === newItem.partNumber && item.description === newItem.description
            );
            
            if (!isDuplicate) {
                scannedItems.push(newItem);
                showStatus(`✅ Added: ${newItem.partNumber}`, 'success');
            } else {
                showStatus('Item already in list', 'info');
            }
            
            // Clear for next item
            partNumberInput.value = '';
            commentInput.value = '';
            
            // Hide keyboard on mobile
            partNumberInput.blur();
            commentInput.blur();
            
            updateUI();
        }
        
        function clearAllItems() {
            scannedItems = [];
            document.getElementById('partNumberInput').value = '';
            document.getElementById('commentInput').value = '';
            updateUI();
            showStatus('All items cleared', 'info');
        }
        
        async function startCamera() {
            try {
                const video = document.getElementById('video');
                const placeholder = document.getElementById('placeholder');
                const scannerActive = document.getElementById('scannerActive');
                const overlay = document.getElementById('overlay');
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                const cameraInfo = document.getElementById('cameraInfo');
                
                showStatus('Starting camera...', 'info');
                
                qrScanner = new QrScanner(video, result => {
                    handleNewScan(result.data);
                }, {
                    preferredCamera: 'environment',
                    highlightScanRegion: false,
                    highlightCodeOutline: false,
                    maxScansPerSecond: 2,
                    returnDetailedScanResult: true,
                });
                
                await qrScanner.start();
                
                placeholder.style.display = 'none';
                overlay.classList.add('active');
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                
                setTimeout(() => {
                    try {
                        video.style.display = 'block';
                        video.play().catch(() => {
                            console.log('Video play failed, showing scanner active overlay');
                            video.style.display = 'none';
                            scannerActive.style.display = 'flex';
                        });
                    } catch (e) {
                        console.log('Video setup failed:', e);
                        scannerActive.style.display = 'flex';
                    }
                }, 100);
                
                if (isIOS) {
                    cameraInfo.style.display = 'block';
                    scannerActive.style.display = 'flex';
                }
                
                showStatus('Camera active - point at QR codes to scan', 'success');
                
                let videoCheckCount = 0;
                const checkVideo = setInterval(() => {
                    videoCheckCount++;
                    if (video.videoWidth > 0 && video.videoHeight > 0) {
                        scannerActive.style.display = 'none';
                        clearInterval(checkVideo);
                    } else if (videoCheckCount > 10) {
                        scannerActive.style.display = 'flex';
                        clearInterval(checkVideo);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Camera error:', error);
                resetCameraUI();
                
                if (error.name === 'NotAllowedError') {
                    showStatus('❌ Camera permission denied. Please allow camera access and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showStatus('❌ No camera found on this device.', 'error');
                } else {
                    showStatus('❌ Camera error: ' + error.message, 'error');
                }
            }
        }
        
        function stopCamera() {
            if (qrScanner) {
                qrScanner.stop();
                qrScanner.destroy();
                qrScanner = null;
            }
            
            resetCameraUI();
            showStatus('Camera stopped', 'info');
        }
        
        function resetCameraUI() {
            const video = document.getElementById('video');
            const placeholder = document.getElementById('placeholder');
            const scannerActive = document.getElementById('scannerActive');
            const overlay = document.getElementById('overlay');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const cameraInfo = document.getElementById('cameraInfo');
            
            video.style.display = 'none';
            scannerActive.style.display = 'none';
            placeholder.style.display = 'flex';
            overlay.classList.remove('active');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            cameraInfo.style.display = 'none';
        }
        
        async function sendToSharePoint() {
            if (!checkURLConfiguration()) {
                return;
            }
            
            if (scannedItems.length === 0) {
                showStatus('No items to send', 'error');
                return;
            }
            
            try {
                showStatus('Checking items in SharePoint...', 'info');
                
                const response = await fetch(sharePointURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        qrCodes: scannedItems.map(item => ({
                            partNumber: item.partNumber,
                            description: item.description,
                            comments: item.comments,
                            timestamp: item.timestamp
                        })),
                        comments: '',
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        checkExistingItems: true
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    handleSharePointResponse(data);
                } else {
                    showStatus(`❌ Error: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('Send error:', error);
                showStatus('❌ Network error - check your connection and URL', 'error');
            }
        }
        
        function handleSharePointResponse(data) {
            try {
                const itemsAdded = data.itemsAdded || 0;
                const itemsSkipped = data.itemsSkipped || 0;
                
                let message = '✅ Success! ';
                if (itemsAdded > 0 && itemsSkipped > 0) {
                    message += `${itemsAdded} added, ${itemsSkipped} already in system`;
                } else if (itemsAdded > 0) {
                    message += `${itemsAdded} items added`;
                } else if (itemsSkipped > 0) {
                    message += `${itemsSkipped} items already in system`;
                } else {
                    message += 'All items processed';
                }
                
                showStatus(message, 'success');
                
                // Show detailed results if available
                if (data.itemDetails && data.itemDetails.length > 0) {
                    setTimeout(() => {
                        showResultsModal(data.itemDetails);
                    }, 1000);
                }
                
                // Clear items after successful send
                scannedItems = [];
                document.getElementById('partNumberInput').value = '';
                document.getElementById('commentInput').value = '';
                updateUI();
                
            } catch (error) {
                console.error('Response parsing error:', error);
                showStatus('✅ Successfully processed items!', 'success');
                
                // Clear items anyway
                scannedItems = [];
                document.getElementById('partNumberInput').value = '';
                document.getElementById('commentInput').value = '';
                updateUI();
            }
        }
        
        function showResultsModal(itemDetails) {
            const modal = document.getElementById('resultsModal');
            const subtitle = document.getElementById('resultsSubtitle');
            const statsRow = document.getElementById('statsRow');
            const resultsTable = document.getElementById('resultsTable');
            
            // Update subtitle
            subtitle.textContent = `${itemDetails.length} items processed successfully`;
            
            // Calculate stats
            const stats = {
                added: itemDetails.filter(item => item.status.toLowerCase() === 'added').length,
                ordered: itemDetails.filter(item => item.status.toLowerCase() === 'ordered').length,
                received: itemDetails.filter(item => item.status.toLowerCase() === 'received').length,
                notOrdered: itemDetails.filter(item => item.status.toLowerCase() === 'not ordered').length
            };
            
            // Build stats row
            statsRow.innerHTML = `
                <div class="stat-badge added">
                    <div class="stat-count">${stats.added}</div>
                    <div class="stat-label">Added</div>
                </div>
                <div class="stat-badge ordered">
                    <div class="stat-count">${stats.ordered}</div>
                    <div class="stat-label">Ordered</div>
                </div>
                <div class="stat-badge received">
                    <div class="stat-count">${stats.received}</div>
                    <div class="stat-label">Received</div>
                </div>
                <div class="stat-badge not-ordered">
                    <div class="stat-count">${stats.notOrdered}</div>
                    <div class="stat-label">Not Ordered</div>
                </div>
            `;
            
            // Build results table
            resultsTable.innerHTML = itemDetails.map(item => {
                const statusClass = item.status.toLowerCase().replace(' ', '-');
                const icon = getStatusIcon(item.status.toLowerCase());
                
                return `
                    <div class="result-row ${statusClass}">
                        <div class="result-icon">${icon}</div>
                        <div class="result-info">
                            <div class="result-part">${item.partNumber}</div>
                            <div>
                                <span class="result-status ${statusClass}">${item.status}</span>
                                ${item.poNumber ? `<span class="result-po">PO: ${item.poNumber}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            modal.style.display = 'flex';
        }
        
        function getStatusIcon(status) {
            switch (status) {
                case 'added': return '✅';
                case 'ordered': return '⏰';
                case 'received': return '📋';
                case 'not ordered': return '⚠️';
                default: return '❓';
            }
        }
        
        function closeResultsModal() {
            document.getElementById('resultsModal').style.display = 'none';
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = 'status';
                }, 4000);
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved URL
            loadSavedURL();
            
            // Update UI initially
            updateUI();
            
            // Part number input listener
            document.getElementById('partNumberInput').addEventListener('input', updateUI);
            
            // Mobile-friendly event listeners
            document.addEventListener('touchstart', function() {}, true);
            
            // Handle keyboard events
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    const modal = document.getElementById('urlModal');
                    if (modal.style.display === 'flex') {
                        saveUrlFromModal();
                    }
                }
                if (event.key === 'Escape') {
                    closeModal();
                    closeResultsModal();
                }
            });
            
            // Auto-show URL modal if no URL is configured
            setTimeout(() => {
                if (!sharePointURL) {
                    showURLModal();
                }
            }, 500);
        });
        
        // iOS Safari specific fixes
        if (isIOS) {
            console.log('iOS device detected - applying fixes');
            
            // Prevent zoom on input focus
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
            }
        }
        
        console.log('QR Scanner initialized', { isIOS, userAgent: navigator.userAgent });
    </script>
</body>
</html>
